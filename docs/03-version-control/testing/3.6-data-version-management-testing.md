# 3.6 Data Version Management Setup 테스트 가이드

## 📋 테스트 개요

**목표**: 데이터 버전 관리 시스템의 모든 기능이 WSL + Docker 환경에서 정상 작동하는지 검증
**테스트 범위**: DVC, 간단한 파일 기반 버전 관리, 자동화 스크립트, 모니터링
**예상 소요 시간**: 45-60분

---

## 🧪 사전 준비

### 환경 설정 확인

```bash
# WSL Ubuntu 환경에서 실행
cd /mnt/c/dev/movie-mlops

# 현재 상태 확인
pwd
git status

# 필요 패키지 설치 확인
pip install -r docs/03-version-control/requirements-dev.txt

# Docker 서비스 확인
sudo service docker start
docker --version

# 테스트용 데이터 파일 존재 확인
find data/ -type f -name "*.json" | head -5
```

---

## 🎯 테스트 시나리오 1: DVC 설치 및 기본 설정 검증

### 1.1 DVC 설치 확인

```bash
echo "📦 DVC 설치 상태 확인..."

# DVC 설치 확인
if command -v dvc &> /dev/null; then
    echo "✅ DVC 설치됨: $(dvc version)"
    
    # DVC 초기화 상태 확인
    if [ -d ".dvc" ]; then
        echo "✅ DVC 초기화됨"
        echo "DVC 설정:"
        ls -la .dvc/
    else
        echo "❌ DVC 초기화되지 않음"
        echo "DVC 초기화 실행..."
        dvc init
        if [ $? -eq 0 ]; then
            echo "✅ DVC 초기화 완료"
        else
            echo "❌ DVC 초기화 실패"
        fi
    fi
else
    echo "❌ DVC가 설치되지 않았습니다"
    echo "DVC 설치 중..."
    pip install 'dvc[all]>=3.55.2,<4.0.0'
    
    if command -v dvc &> /dev/null; then
        echo "✅ DVC 설치 완료"
        dvc init
    else
        echo "❌ DVC 설치 실패"
    fi
fi
```

### 1.2 DVC 원격 스토리지 설정 확인

```bash
echo "🗄️ DVC 원격 스토리지 설정 확인..."

# 원격 스토리지 설정 확인
dvc remote list
if [ $? -eq 0 ]; then
    echo "✅ DVC 원격 스토리지 설정 확인됨"
    
    # 로컬 스토리지 디렉터리 확인
    if [ -d "data/dvc-storage" ]; then
        echo "✅ 로컬 DVC 스토리지 디렉터리 존재"
    else
        echo "📁 로컬 DVC 스토리지 디렉터리 생성..."
        mkdir -p data/dvc-storage
        dvc remote add -d local_storage data/dvc-storage
        echo "✅ 로컬 DVC 스토리지 설정 완료"
    fi
else
    echo "⚠️ DVC 원격 스토리지 설정 없음"
fi
```

### 1.3 DVC 파이프라인 설정 확인

```bash
echo "⚙️ DVC 파이프라인 설정 확인..."

if [ -f "dvc.yaml" ]; then
    echo "✅ dvc.yaml 파일 존재"
    
    # YAML 파일 유효성 검사
    python -c "
import yaml
try:
    with open('dvc.yaml', 'r') as f:
        yaml.safe_load(f)
    print('✅ dvc.yaml 형식 유효')
except yaml.YAMLError as e:
    print(f'❌ dvc.yaml 형식 오류: {e}')
except Exception as e:
    print(f'❌ dvc.yaml 읽기 오류: {e}')
"
    
    # DVC 파이프라인 상태 확인
    echo "DVC 파이프라인 상태:"
    dvc status || echo "파이프라인 상태 확인 완료"
    
    # DVC DAG 확인
    echo "DVC 파이프라인 DAG:"
    dvc dag || echo "DAG 확인 완료"
    
else
    echo "❌ dvc.yaml 파일 없음"
fi
```

---

## 🎯 테스트 시나리오 2: 간단한 파일 기반 버전 관리 테스트

### 2.1 데이터 버전 관리 스크립트 존재 확인

```bash
echo "📝 데이터 버전 관리 스크립트 확인..."

# 필수 스크립트 파일들 확인
scripts=(
    "src/data/utils/data_versioning.py"
    "scripts/data_version_manager.py"
    "scripts/data_change_monitor.py"
)

for script in "${scripts[@]}"; do
    if [ -f "$script" ]; then
        echo "✅ $script 존재"
        # 실행 권한 확인
        if [ -x "$script" ]; then
            echo "  └─ 실행 권한 있음"
        else
            echo "  └─ 실행 권한 부여..."
            chmod +x "$script"
        fi
    else
        echo "❌ $script 없음"
    fi
done
```

### 2.2 테스트용 데이터 파일 생성

```bash
echo "📊 테스트용 데이터 파일 생성..."

# 테스트 데이터 디렉터리 생성
mkdir -p test_data_versioning

# 작은 JSON 데이터 파일 생성
cat > test_data_versioning/small_dataset.json << 'EOF'
{
    "metadata": {
        "version": "1.0",
        "created": "2025-06-06",
        "description": "Small test dataset"
    },
    "data": [
        {"id": 1, "name": "Test Record 1", "value": 100},
        {"id": 2, "name": "Test Record 2", "value": 200},
        {"id": 3, "name": "Test Record 3", "value": 300}
    ]
}
EOF

# 중간 크기 데이터 파일 생성
echo "📊 중간 크기 데이터 파일 생성..."
python -c "
import json
data = {
    'metadata': {'version': '1.0', 'description': 'Medium test dataset'},
    'records': [{'id': i, 'data': f'record_{i}', 'score': i * 10} for i in range(1000)]
}
with open('test_data_versioning/medium_dataset.json', 'w') as f:
    json.dump(data, f, indent=2)
print('✅ 중간 크기 데이터 파일 생성 완료')
"

echo "✅ 테스트 데이터 파일 생성 완료"
ls -lh test_data_versioning/
```

### 2.3 데이터 버전 관리 CLI 테스트

```bash
echo "🔧 데이터 버전 관리 CLI 테스트..."

if [ -f "scripts/data_version_manager.py" ]; then
    # 도움말 확인
    echo "1. CLI 도움말 테스트:"
    python scripts/data_version_manager.py --help
    
    echo ""
    echo "2. 데이터 파일 버전 등록 테스트:"
    python scripts/data_version_manager.py version \
        "test_data_versioning/small_dataset.json" \
        "test_small_data" \
        --description "First version of small test dataset"
    
    if [ $? -eq 0 ]; then
        echo "✅ 데이터 버전 등록 성공"
        
        echo ""
        echo "3. 버전 목록 조회 테스트:"
        python scripts/data_version_manager.py list test_small_data
        
        echo ""
        echo "4. 두 번째 버전 등록 테스트:"
        # 파일 내용 수정
        python -c "
import json
with open('test_data_versioning/small_dataset.json', 'r') as f:
    data = json.load(f)
data['metadata']['version'] = '2.0'
data['data'].append({'id': 4, 'name': 'Test Record 4', 'value': 400})
with open('test_data_versioning/small_dataset.json', 'w') as f:
    json.dump(data, f, indent=2)
"
        
        python scripts/data_version_manager.py version \
            "test_data_versioning/small_dataset.json" \
            "test_small_data" \
            --description "Second version with additional record"
        
        echo ""
        echo "5. 전체 버전 히스토리 확인:"
        python scripts/data_version_manager.py list test_small_data
        
    else
        echo "❌ 데이터 버전 등록 실패"
    fi
    
else
    echo "❌ data_version_manager.py 스크립트 없음"
fi
```

---

## 🎯 테스트 시나리오 3: 통합 시나리오 테스트

### 3.1 실제 데이터 처리 워크플로우 시뮬레이션

```bash
echo "🔄 실제 데이터 처리 워크플로우 시뮬레이션..."

echo "1. 새 데이터 프로젝트 시작:"
# 새 프로젝트 데이터 수집 시뮬레이션
cat > test_data_versioning/project_data_v1.json << 'EOF'
{
    "project": "movie_recommendation",
    "version": "1.0.0",
    "collected_date": "2025-06-06",
    "data_source": "TMDB_API",
    "records": [
        {"movie_id": 1, "title": "Test Movie 1", "rating": 8.5},
        {"movie_id": 2, "title": "Test Movie 2", "rating": 7.8},
        {"movie_id": 3, "title": "Test Movie 3", "rating": 9.1}
    ]
}
EOF

echo "✅ 초기 프로젝트 데이터 생성"

echo ""
echo "2. 데이터 버전 등록 및 추적:"
python scripts/data_version_manager.py version \
    "test_data_versioning/project_data_v1.json" \
    "movie_project_data" \
    --description "Initial movie data collection"

echo ""
echo "3. 데이터 확장 (새로운 영화 추가):"
python -c "
import json
with open('test_data_versioning/project_data_v1.json', 'r') as f:
    data = json.load(f)
data['version'] = '1.1.0'
data['records'].extend([
    {'movie_id': 4, 'title': 'Test Movie 4', 'rating': 8.2},
    {'movie_id': 5, 'title': 'Test Movie 5', 'rating': 7.5}
])
with open('test_data_versioning/project_data_v1.json', 'w') as f:
    json.dump(data, f, indent=2)
print('✅ 데이터 확장 완료')
"

# 새 버전 등록
python scripts/data_version_manager.py version \
    "test_data_versioning/project_data_v1.json" \
    "movie_project_data" \
    --description "Added new movie records"

echo ""
echo "4. 전체 버전 히스토리 확인:"
python scripts/data_version_manager.py list movie_project_data

echo "✅ 실제 워크플로우 시뮬레이션 완료"
```

---

## 🎯 테스트 시나리오 4: 성능 및 확장성 테스트

### 4.1 대용량 데이터 처리 성능 테스트

```bash
echo "⚡ 대용량 데이터 처리 성능 테스트..."

echo "1. 다양한 크기 테스트 파일 생성:"

# 작은 파일 (1MB)
python -c "
import json
small_data = {'records': [{'id': i, 'data': f'record_{i}' * 100} for i in range(1000)]}
with open('test_data_versioning/small_1mb.json', 'w') as f:
    json.dump(small_data, f)
print('✅ 1MB 파일 생성')
"

# 중간 파일 (10MB)
python -c "
import json
medium_data = {'records': [{'id': i, 'data': f'record_{i}' * 1000} for i in range(1000)]}
with open('test_data_versioning/medium_10mb.json', 'w') as f:
    json.dump(medium_data, f)
print('✅ 10MB 파일 생성')
"

echo ""
echo "2. 데이터 버전 관리 성능 측정:"

# 성능 측정
files=("test_data_versioning/small_1mb.json" "test_data_versioning/medium_10mb.json")
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo "파일: $file"
        
        start_time=$(date +%s)
        python scripts/data_version_manager.py version \
            "$file" \
            "perf_test_$(basename $file .json)" \
            --description "Performance test" > /dev/null 2>&1
        end_time=$(date +%s)
        
        duration=$((end_time - start_time))
        file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        file_size_mb=$((file_size / 1024 / 1024))
        
        echo "  - 크기: ${file_size_mb}MB"
        echo "  - 처리 시간: ${duration}초"
        
        if [ $duration -lt 10 ]; then
            echo "  - ✅ 성능 양호"
        else
            echo "  - ⚠️ 성능 개선 필요"
        fi
    fi
done
```

---

## 🎯 테스트 시나리오 5: Docker 환경 통합 테스트

### 5.1 Docker 컨테이너에서 DVC 테스트

```bash
echo "🐳 Docker 환경 DVC 테스트..."

if [ -f "Dockerfile.dev" ]; then
    echo "1. Docker 이미지 빌드:"
    docker build -f Dockerfile.dev -t movie-mlops-dvc-test . > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "✅ Docker 이미지 빌드 성공"
        
        echo ""
        echo "2. 컨테이너에서 DVC 명령어 테스트:"
        docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            movie-mlops-dvc-test \
            bash -c "
                echo '🔍 Docker 환경에서 DVC 테스트'
                dvc version
                dvc status || echo 'DVC 상태 확인 완료'
                echo '✅ Docker 환경 DVC 테스트 완료'
            "
        
        if [ $? -eq 0 ]; then
            echo "✅ Docker 환경 DVC 테스트 통과"
        else
            echo "❌ Docker 환경 DVC 테스트 실패"
        fi
        
        # 테스트용 이미지 정리
        docker rmi movie-mlops-dvc-test > /dev/null 2>&1
        
    else
        echo "❌ Docker 이미지 빌드 실패"
    fi
else
    echo "⚠️ Dockerfile.dev를 찾을 수 없습니다. Docker 테스트 스킵"
fi
```

---

## 🎯 테스트 시나리오 6: 오류 처리 및 복원력 테스트

### 6.1 비정상 상황 처리 테스트

```bash
echo "🛡️ 오류 처리 및 복원력 테스트..."

# 1. 존재하지 않는 파일 처리
echo "1. 존재하지 않는 파일 처리:"
python scripts/data_version_manager.py version \
    "nonexistent_file.json" \
    "test_nonexistent" 2>&1 | head -3
echo "✅ 존재하지 않는 파일 오류 처리 확인"

# 2. 잘못된 JSON 파일 처리
echo ""
echo "2. 잘못된 JSON 파일 처리:"
echo "invalid json content {" > test_data_versioning/invalid.json

python scripts/data_version_manager.py version \
    "test_data_versioning/invalid.json" \
    "test_invalid" 2>&1 | head -3
echo "✅ 잘못된 JSON 파일 오류 처리 확인"

# 3. 권한 문제 시뮬레이션
echo ""
echo "3. 파일 권한 문제 처리:"
echo '{"test": "readonly"}' > test_data_versioning/readonly.json
chmod 444 test_data_versioning/readonly.json

python scripts/data_version_manager.py version \
    "test_data_versioning/readonly.json" \
    "test_readonly" 2>&1 | head -3

# 권한 복구
chmod 644 test_data_versioning/readonly.json
echo "✅ 권한 문제 오류 처리 확인"
```

---

## 🎯 테스트 시나리오 7: 정리 및 최종 검증

### 7.1 테스트 환경 정리

```bash
echo "🧹 테스트 환경 정리..."

# 테스트 파일들 정리
rm -rf test_data_versioning/
rm -f *.dvc 2>/dev/null || true

# DVC 캐시 정리 (선택적)
if command -v dvc &> /dev/null; then
    dvc cache dir
    # 캐시 크기가 크면 정리
    dvc gc
fi

echo "✅ 테스트 환경 정리 완료"
```

### 7.2 최종 검증 및 요약

```bash
echo "📊 최종 검증 및 테스트 요약..."

# 필수 구성 요소 확인
echo "🔍 최종 구성 요소 확인:"

components_check=true

# DVC 설치 확인
if command -v dvc &> /dev/null; then
    echo "✅ DVC: 설치됨"
else
    echo "❌ DVC: 설치되지 않음"
    components_check=false
fi

# 스크립트 확인
if [ -f "scripts/data_version_manager.py" ]; then
    echo "✅ 데이터 버전 관리 스크립트: 존재"
else
    echo "❌ 데이터 버전 관리 스크립트: 없음"
    components_check=false
fi

# DVC 설정 확인
if [ -d ".dvc" ]; then
    echo "✅ DVC 초기화: 완료"
else
    echo "❌ DVC 초기화: 미완료"
    components_check=false
fi

# 데이터 레지스트리 확인
if [ -f "data/data_registry.json" ]; then
    echo "✅ 데이터 레지스트리: 생성됨"
else
    echo "⚠️ 데이터 레지스트리: 생성되지 않음 (사용 후 생성됨)"
fi

# 전체 테스트 결과 요약
echo ""
if $components_check; then
    echo "🎉 3.6 Data Version Management Setup 테스트 완료!"
    echo ""
    echo "✅ 통과한 테스트들:"
    echo "  - DVC 설치 및 설정"
    echo "  - 간단한 파일 기반 버전 관리"
    echo "  - 데이터 버전 관리 CLI"
    echo "  - 실제 워크플로우 시뮬레이션"
    echo "  - 성능 테스트"
    echo "  - Docker 환경 통합"
    echo "  - 오류 처리 및 복원력"
    echo ""
    echo "🚀 데이터 버전 관리 시스템이 정상적으로 구성되었습니다!"
    echo "💡 이제 체계적인 데이터 버전 관리가 가능합니다."
else
    echo ""
    echo "❌ 일부 테스트에서 문제가 발견되었습니다."
    echo "🔧 위의 오류를 해결한 후 다시 테스트해 주세요."
fi
```

---

## 📋 테스트 체크리스트

### 필수 테스트 항목
- [ ] DVC 설치 및 초기화 확인
- [ ] DVC 원격 스토리지 설정
- [ ] 데이터 버전 관리 스크립트 정상 작동
- [ ] 간단한 파일 기반 버전 관리 정상 작동
- [ ] 데이터 레지스트리 생성 및 관리
- [ ] 실제 워크플로우 시뮬레이션 성공
- [ ] 오류 상황 적절한 처리

### 성능 테스트 항목
- [ ] 대용량 파일 처리 성능 (10초 이내)
- [ ] 메모리 사용량 합리적 수준
- [ ] 동시 접근 처리 가능
- [ ] 확장 가능한 구조

### 통합 테스트 항목
- [ ] Docker 환경에서 정상 작동
- [ ] Git과의 통합 확인
- [ ] 기존 데이터 파일과의 호환성
- [ ] 실제 프로젝트 데이터 처리

---

## 🔧 문제 해결 가이드

### 일반적인 문제들

**Q: DVC 설치 오류**
```bash
# 의존성 문제 해결
pip install --upgrade pip
pip install 'dvc[all]>=3.55.2,<4.0.0'
```

**Q: DVC 초기화 실패**
```bash
# 기존 .dvc 디렉터리 정리 후 재시도
rm -rf .dvc/
dvc init
```

**Q: 파이썬 스크립트 import 오류**
```bash
# PYTHONPATH 설정 확인
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
```

**Q: 데이터 레지스트리 오류**
```bash
# 레지스트리 파일 권한 확인
chmod 644 data/data_registry.json
```

---

이 테스트 가이드를 통해 3.6 Data Version Management Setup의 모든 기능이 정상적으로 작동하는지 체계적으로 검증할 수 있습니다.
