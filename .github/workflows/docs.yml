name: ğŸ“š Documentation Update

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'pyproject.toml'
      - 'requirements/**'
  workflow_dispatch:

jobs:
  # ==============================================================================
  # 1. ë¬¸ì„œ ê²€ì¦
  # ==============================================================================
  validate-docs:
    name: âœ… Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“ Validate Markdown files
      run: |
        echo "ğŸ“ Validating Markdown files..."
        
        # ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ê²€ì‚¬
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | while read -r file; do
          echo "Checking $file..."
          # ê¸°ë³¸ì ì¸ ë§ˆí¬ë‹¤ìš´ êµ¬ì¡° ê²€ì‚¬
          if grep -q "^#" "$file"; then
            echo "âœ… $file has headers"
          else
            echo "âš ï¸ $file may be missing headers"
          fi
        done
        
    - name: ğŸ”— Check internal links
      run: |
        echo "ğŸ”— Checking internal documentation links..."
        
        # docs í´ë” ë‚´ ìƒí˜¸ ì°¸ì¡° ë§í¬ ê²€ì‚¬
        find docs/ -name "*.md" | while read -r file; do
          echo "Checking links in $file..."
          
          # ìƒëŒ€ ê²½ë¡œ ë§í¬ ì¶”ì¶œ ë° ê²€ì‚¬
          grep -o '\[.*\](\.\/.*\.md)' "$file" | sed 's/.*](\(.*\))/\1/' | while read -r link; do
            if [ -f "$(dirname "$file")/$link" ]; then
              echo "âœ… Link exists: $link"
            else
              echo "âŒ Broken link: $link in $file"
            fi
          done
        done
        
    - name: ğŸ“Š Generate docs validation report
      run: |
        echo "## ğŸ“š Documentation Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Markdown syntax validation completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Internal link validation completed" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # 2. API ë¬¸ì„œ ìë™ ìƒì„±
  # ==============================================================================
  generate-api-docs:
    name: ğŸ“– Generate API Documentation
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'
        
    - name: ğŸ“¦ Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        pip install -r requirements/api.txt
        pip install sphinx sphinx-rtd-theme sphinx-autoapi
        
    - name: ğŸ“– Generate API documentation
      run: |
        echo "ğŸ“– Generating API documentation..."
        
        # Sphinx ë¬¸ì„œ ìƒì„±ì„ ìœ„í•œ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
        mkdir -p docs/api
        
        # ì„ì‹œë¡œ API ë¬¸ì„œ êµ¬ì¡° ìƒì„±
        cat > docs/api/index.md << 'EOF'
# ğŸš€ Movie MLOps API Documentation

## ê°œìš”
Movie MLOps ì‹œìŠ¤í…œì˜ REST API ë¬¸ì„œì…ë‹ˆë‹¤.

## ì—”ë“œí¬ì¸íŠ¸

### ğŸ¬ ì˜í™” ì¶”ì²œ API

#### GET /api/v1/recommendations
ì‚¬ìš©ìë¥¼ ìœ„í•œ ì˜í™” ì¶”ì²œ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

**Parameters:**
- `user_id` (int): ì‚¬ìš©ì ID
- `k` (int, optional): ì¶”ì²œí•  ì˜í™” ê°œìˆ˜ (ê¸°ë³¸ê°’: 10)

**Response:**
```json
{
  "recommendations": [
    {
      "movie_id": 123,
      "title": "ì˜í™” ì œëª©",
      "score": 0.95
    }
  ]
}
```

#### POST /api/v1/feedback
ì‚¬ìš©ì í”¼ë“œë°±ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

**Request Body:**
```json
{
  "user_id": 123,
  "movie_id": 456,
  "rating": 4.5,
  "action": "like"
}
```

### ğŸ” í—¬ìŠ¤ ì²´í¬

#### GET /health
ì‹œìŠ¤í…œ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-06-08T10:00:00Z",
  "services": {
    "database": "healthy",
    "model": "healthy"
  }
}
```
EOF
        
        echo "âœ… API documentation generated" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“¤ Upload API docs
      uses: actions/upload-artifact@v3
      with:
        name: api-documentation
        path: docs/api/

  # ==============================================================================
  # 3. ì˜ì¡´ì„± ë¬¸ì„œ ì—…ë°ì´íŠ¸
  # ==============================================================================
  update-dependency-docs:
    name: ğŸ“¦ Update Dependency Documentation
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'
        
    - name: ğŸ“¦ Generate dependency documentation
      run: |
        echo "ğŸ“¦ Generating dependency documentation..."
        
        # ì˜ì¡´ì„± ë§¤íŠ¸ë¦­ìŠ¤ ìë™ ì—…ë°ì´íŠ¸
        cat > docs/overview/DEPENDENCY_STATUS.md << 'EOF'
---
title: ì˜ì¡´ì„± ìƒíƒœ ë³´ê³ ì„œ (ìë™ ìƒì„±)
description: í˜„ì¬ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ë“¤ì˜ ìƒíƒœ ë° ë²„ì „ ì •ë³´
generated: true
date: $(date +%Y-%m-%d)
---

# ğŸ“¦ ì˜ì¡´ì„± ìƒíƒœ ë³´ê³ ì„œ

> **ìë™ ìƒì„± ë¬¸ì„œ**: ì´ ë¬¸ì„œëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

## ğŸ“Š íŒ¨í‚¤ì§€ í˜„í™©

### í•µì‹¬ íŒ¨í‚¤ì§€ ë²„ì „
EOF
        
        # requirements íŒŒì¼ë“¤ ë¶„ì„í•˜ì—¬ ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „ ì¶”ì¶œ
        echo "" >> docs/overview/DEPENDENCY_STATUS.md
        echo "| íŒ¨í‚¤ì§€ | í˜„ì¬ ë²„ì „ | ë²”ì£¼ |" >> docs/overview/DEPENDENCY_STATUS.md
        echo "|--------|-----------|------|" >> docs/overview/DEPENDENCY_STATUS.md
        
        # base.txtì—ì„œ ì£¼ìš” íŒ¨í‚¤ì§€ ì¶”ì¶œ
        if [ -f "requirements/base.txt" ]; then
          grep -E "^(numpy|pandas|scikit-learn)" requirements/base.txt | while read -r line; do
            package=$(echo "$line" | cut -d'=' -f1)
            version=$(echo "$line" | cut -d'=' -f3)
            echo "| $package | $version | ê¸°ë³¸ |" >> docs/overview/DEPENDENCY_STATUS.md
          done
        fi
        
        # ë‹¤ë¥¸ requirements íŒŒì¼ë“¤ë„ ì²˜ë¦¬
        for req_file in requirements/*.txt; do
          if [ "$req_file" != "requirements/base.txt" ]; then
            service=$(basename "$req_file" .txt)
            echo "" >> docs/overview/DEPENDENCY_STATUS.md
            echo "### $service ì„œë¹„ìŠ¤" >> docs/overview/DEPENDENCY_STATUS.md
            echo "" >> docs/overview/DEPENDENCY_STATUS.md
            
            # ì²« ë²ˆì§¸ ì£¼ìš” íŒ¨í‚¤ì§€ë§Œ í‘œì‹œ
            head -5 "$req_file" | grep -v "^#" | grep -v "^-r" | while read -r line; do
              if [ -n "$line" ]; then
                echo "- \`$line\`" >> docs/overview/DEPENDENCY_STATUS.md
              fi
            done
          fi
        done
        
        echo "" >> docs/overview/DEPENDENCY_STATUS.md
        echo "## ğŸ”„ ì—…ë°ì´íŠ¸ ì •ë³´" >> docs/overview/DEPENDENCY_STATUS.md
        echo "" >> docs/overview/DEPENDENCY_STATUS.md
        echo "- **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: $(date)" >> docs/overview/DEPENDENCY_STATUS.md
        echo "- **ë‹¤ìŒ ì˜ˆì • ì—…ë°ì´íŠ¸**: ë§¤ì£¼ ì›”ìš”ì¼ ìë™ ì‹¤í–‰" >> docs/overview/DEPENDENCY_STATUS.md
        echo "- **ë³´ì•ˆ ìŠ¤ìº”**: CI/CDì—ì„œ ìë™ ì‹¤í–‰" >> docs/overview/DEPENDENCY_STATUS.md
        
        echo "âœ… Dependency documentation updated" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“ Commit dependency docs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet docs/overview/DEPENDENCY_STATUS.md; then
          echo "No changes to dependency documentation"
        else
          git add docs/overview/DEPENDENCY_STATUS.md
          git commit -m "ğŸ“¦ Update dependency documentation [skip ci]"
          git push
        fi

  # ==============================================================================
  # 4. ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±
  # ==============================================================================
  generate-architecture-diagrams:
    name: ğŸ—ï¸ Generate Architecture Diagrams
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¨ Install diagram tools
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip graphviz
        pip install diagrams
        
    - name: ğŸ—ï¸ Generate architecture diagrams
      run: |
        echo "ğŸ—ï¸ Generating architecture diagrams..."
        
        mkdir -p docs/diagrams
        
        # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±
        cat > generate_diagrams.py << 'EOF'
from diagrams import Diagram, Cluster, Edge
from diagrams.onprem.container import Docker
from diagrams.onprem.database import PostgreSQL, Redis
from diagrams.onprem.monitoring import Prometheus, Grafana
from diagrams.programming.framework import FastAPI, React
from diagrams.programming.language import Python
from diagrams.onprem.workflow import Airflow
from diagrams.onprem.queue import Kafka

# MLOps ì „ì²´ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨
with Diagram("MLOps 9ì•„í‚¤í…ì²˜ ì „ì²´ êµ¬ì¡°", filename="docs/diagrams/mlops_architecture", show=False):
    with Cluster("1+5ì•„í‚¤í…ì²˜: Airflow ìƒíƒœê³„"):
        airflow = Airflow("Apache Airflow")
    
    with Cluster("2ì•„í‚¤í…ì²˜: í”¼ì²˜ ìŠ¤í† ì–´"):
        feast = Python("Feast")
    
    with Cluster("3+4ì•„í‚¤í…ì²˜: Git ìƒíƒœê³„"):
        git = Python("Git + GitHub Actions")
    
    with Cluster("6ì•„í‚¤í…ì²˜: ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬"):
        mlflow = Python("MLflow")
    
    with Cluster("7ì•„í‚¤í…ì²˜: ML í”„ë ˆì„ì›Œí¬"):
        pytorch = Python("PyTorch")
        api = FastAPI("FastAPI")
    
    with Cluster("8ì•„í‚¤í…ì²˜: ëª¨ë‹ˆí„°ë§"):
        prometheus = Prometheus("Prometheus")
        grafana = Grafana("Grafana")
    
    with Cluster("9ì•„í‚¤í…ì²˜: ì´ë²¤íŠ¸ ê¸°ë°˜"):
        kafka = Kafka("Apache Kafka")
    
    with Cluster("ë°ì´í„°ë² ì´ìŠ¤"):
        postgres = PostgreSQL("PostgreSQL")
        redis = Redis("Redis")
    
    # ì—°ê²° ê´€ê³„
    airflow >> feast
    airflow >> mlflow
    mlflow >> pytorch
    pytorch >> api
    api >> kafka
    prometheus >> grafana
    
    postgres >> [airflow, mlflow]
    redis >> [airflow, feast]

print("âœ… Architecture diagram generated")
EOF
        
        python generate_diagrams.py
        
        echo "âœ… Architecture diagrams generated" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“¤ Upload diagrams
      uses: actions/upload-artifact@v3
      with:
        name: architecture-diagrams
        path: docs/diagrams/

  # ==============================================================================
  # 5. ë¬¸ì„œ ì‚¬ì´íŠ¸ ë°°í¬ (GitHub Pages)
  # ==============================================================================
  deploy-docs:
    name: ğŸš€ Deploy Documentation Site
    runs-on: ubuntu-latest
    needs: [generate-api-docs, update-dependency-docs, generate-architecture-diagrams]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download generated docs
      uses: actions/download-artifact@v3
      with:
        pattern: '*-documentation'
        merge-multiple: true
        path: ./generated-docs/
        
    - name: ğŸ“¥ Download diagrams
      uses: actions/download-artifact@v3
      with:
        name: architecture-diagrams
        path: ./docs/diagrams/
        
    - name: ğŸ”§ Setup GitHub Pages
      uses: actions/configure-pages@v3
      
    - name: ğŸ“š Build documentation site
      run: |
        echo "ğŸ“š Building documentation site..."
        
        # ë¬¸ì„œ ì‚¬ì´íŠ¸ êµ¬ì¡° ìƒì„±
        mkdir -p _site
        
        # ê¸°ë³¸ HTML êµ¬ì¡° ìƒì„±
        cat > _site/index.html << 'EOF'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie MLOps Documentation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .card h3 { margin-top: 0; color: #0066cc; }
        .link { color: #0066cc; text-decoration: none; }
        .link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ Movie MLOps Documentation</h1>
            <p>ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œì„ ìœ„í•œ MLOps 9ì•„í‚¤í…ì²˜ ë¬¸ì„œ</p>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>ğŸ“– Overview</h3>
                <p>MLOps ì•„í‚¤í…ì²˜ ì „ì²´ ê°œìš”</p>
                <a href="overview/" class="link">ë¬¸ì„œ ë³´ê¸° â†’</a>
            </div>
            
            <div class="card">
                <h3>ğŸš€ Setup</h3>
                <p>ì‹œìŠ¤í…œ ì„¤ì • ë° ì„¤ì¹˜ ê°€ì´ë“œ</p>
                <a href="setup/" class="link">ë¬¸ì„œ ë³´ê¸° â†’</a>
            </div>
            
            <div class="card">
                <h3>ğŸ”§ API Reference</h3>
                <p>REST API ì‚¬ìš©ë²• ë° ì—”ë“œí¬ì¸íŠ¸</p>
                <a href="api/" class="link">ë¬¸ì„œ ë³´ê¸° â†’</a>
            </div>
            
            <div class="card">
                <h3>ğŸ—ï¸ Architecture</h3>
                <p>ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨</p>
                <a href="diagrams/" class="link">ë‹¤ì´ì–´ê·¸ë¨ ë³´ê¸° â†’</a>
            </div>
        </div>
        
        <div style="margin-top: 40px; text-align: center; color: #666;">
            <p>ğŸ”„ Last updated: $(date)</p>
            <p>ğŸ“Š Generated by GitHub Actions</p>
        </div>
    </div>
</body>
</html>
EOF
        
        # ê¸°ì¡´ ë¬¸ì„œë“¤ì„ _siteë¡œ ë³µì‚¬
        cp -r docs/* _site/ 2>/dev/null || true
        cp -r generated-docs/* _site/ 2>/dev/null || true
        
        # READMEë¥¼ HTMLë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ë°©ë²•)
        if command -v pandoc &> /dev/null; then
          pandoc README.md -o _site/readme.html
        fi
        
        echo "âœ… Documentation site built" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # ==============================================================================
  # 6. ë¬¸ì„œ í’ˆì§ˆ ë³´ê³ ì„œ
  # ==============================================================================
  docs-quality-report:
    name: ğŸ“Š Documentation Quality Report
    runs-on: ubuntu-latest
    needs: [validate-docs, generate-api-docs, update-dependency-docs, generate-architecture-diagrams, deploy-docs]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate quality metrics
      run: |
        echo "ğŸ“Š Generating documentation quality report..."
        
        # ë¬¸ì„œ ìƒíƒœ ìš”ì•½
        echo "## ğŸ“š Documentation Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.validate-docs.result }}" == "success" ]; then
          echo "âœ… **Documentation Validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation Validation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.generate-api-docs.result }}" == "success" ]; then
          echo "âœ… **API Documentation**: Generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **API Documentation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.update-dependency-docs.result }}" == "success" ]; then
          echo "âœ… **Dependency Documentation**: Updated" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Dependency Documentation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.generate-architecture-diagrams.result }}" == "success" ]; then
          echo "âœ… **Architecture Diagrams**: Generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Architecture Diagrams**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy-docs.result }}" == "success" ]; then
          echo "âœ… **Documentation Site**: Deployed" >> $GITHUB_STEP_SUMMARY
          echo "  - ğŸ”— [View Documentation Site](${{ needs.deploy-docs.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-docs.result }}" == "skipped" ]; then
          echo "â­ï¸ **Documentation Site**: Skipped (not main branch)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation Site**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ Recommendations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Review and fix any failed validation checks" >> $GITHUB_STEP_SUMMARY
        echo "- Keep API documentation synchronized with code changes" >> $GITHUB_STEP_SUMMARY
        echo "- Regularly update architecture diagrams" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor documentation site accessibility" >> $GITHUB_STEP_SUMMARY
