name: ðŸ”„ Dependencies Update

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ UTC 1ì‹œ (í•œêµ­ì‹œê°„ 10ì‹œ)ì— ì‹¤í–‰
    - cron: '0 1 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  PYTHON_VERSION: "3.11"
  
jobs:
  # ==============================================================================
  # 1. ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
  # ==============================================================================
  security-scan:
    name: ðŸ›¡ï¸ Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.vulnerabilities }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit
        
    - name: ðŸ›¡ï¸ Run security audit
      id: audit
      run: |
        # Safety ìŠ¤ìº”
        echo "ðŸ›¡ï¸ Running Safety scan..."
        safety check --json > safety-report.json || true
        
        # pip-audit ìŠ¤ìº”
        echo "ðŸ›¡ï¸ Running pip-audit scan..."
        pip-audit --format=json --output=pip-audit-report.json || true
        
        # ì·¨ì•½ì  ë°œê²¬ ì—¬ë¶€ í™•ì¸
        if [ -s safety-report.json ] || [ -s pip-audit-report.json ]; then
          echo "vulnerabilities=true" >> $GITHUB_OUTPUT
          echo "ðŸš¨ Security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        else
          echo "vulnerabilities=false" >> $GITHUB_OUTPUT
          echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“Š Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          pip-audit-report.json

  # ==============================================================================
  # 2. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í™•ì¸
  # ==============================================================================
  check-updates:
    name: ðŸ” Check Available Updates
    runs-on: ubuntu-latest
    
    outputs:
      updates-available: ${{ steps.check.outputs.available }}
      update-summary: ${{ steps.check.outputs.summary }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
        
    - name: ðŸ” Check for updates
      id: check
      run: |
        echo "ðŸ” Checking for dependency updates..."
        
        # ê° requirements íŒŒì¼ë³„ ì—…ë°ì´íŠ¸ í™•ì¸
        update_count=0
        update_summary=""
        
        for req_file in requirements/*.txt; do
          if [ "$req_file" != "requirements/base.txt" ]; then
            echo "Checking $req_file..."
            
            # pip-toolsë¥¼ ì‚¬ìš©í•´ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸
            pip-compile --upgrade --dry-run "$req_file" > "${req_file}.new" || true
            
            if ! diff -q "$req_file" "${req_file}.new" >/dev/null 2>&1; then
              update_count=$((update_count + 1))
              update_summary="$update_summary\n- Updates available in $req_file"
            fi
            
            rm -f "${req_file}.new"
          fi
        done
        
        if [ $update_count -gt 0 ]; then
          echo "available=true" >> $GITHUB_OUTPUT
          echo "summary=$update_summary" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ $update_count requirement files have updates available" >> $GITHUB_STEP_SUMMARY
        else
          echo "available=false" >> $GITHUB_OUTPUT
          echo "summary=No updates available" >> $GITHUB_OUTPUT
          echo "âœ… All dependencies are up to date" >> $GITHUB_STEP_SUMMARY
        fi

  # ==============================================================================
  # 3. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì ìš©
  # ==============================================================================
  update-dependencies:
    name: ðŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    needs: [security-scan, check-updates]
    if: needs.check-updates.outputs.updates-available == 'true' || needs.security-scan.outputs.vulnerabilities-found == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
        
    - name: ðŸ”„ Update base dependencies
      run: |
        echo "ðŸ”„ Updating base dependencies..."
        
        # Update typeì— ë”°ë¥¸ ì—…ë°ì´íŠ¸ ì „ëžµ
        UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
        
        case $UPDATE_TYPE in
          "patch")
            # íŒ¨ì¹˜ ë²„ì „ë§Œ ì—…ë°ì´íŠ¸ (ë³´ì•ˆ ìˆ˜ì • í¬í•¨)
            pip-compile --upgrade requirements/base.txt
            ;;
          "minor")
            # ë§ˆì´ë„ˆ ë²„ì „ê¹Œì§€ ì—…ë°ì´íŠ¸
            pip-compile --upgrade requirements/base.txt
            ;;
          "major")
            # ë©”ì´ì € ë²„ì „ê¹Œì§€ ì—…ë°ì´íŠ¸ (ì£¼ì˜ í•„ìš”)
            pip-compile --upgrade requirements/base.txt
            ;;
        esac
        
    - name: ðŸ”„ Update service-specific dependencies
      run: |
        echo "ðŸ”„ Updating service-specific dependencies..."
        
        # Airflow constraints ì ìš©í•˜ì—¬ ì—…ë°ì´íŠ¸
        AIRFLOW_VERSION=2.10.5
        PYTHON_VERSION="3.11"
        CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
        
        # Airflow ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ (constraints ì ìš©)
        pip-compile --upgrade --constraint "$CONSTRAINT_URL" requirements/airflow.txt
        
        # ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
        for req_file in requirements/api.txt requirements/pytorch.txt requirements/mlflow.txt requirements/feast.txt; do
          pip-compile --upgrade "$req_file"
        done
        
    - name: ðŸ§ª Test updated dependencies
      run: |
        echo "ðŸ§ª Testing updated dependencies..."
        
        # ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜ ë° í…ŒìŠ¤íŠ¸
        pip install -r requirements/base.txt
        python -c "import numpy, pandas, sklearn; print('âœ… Core packages working')"
        
        # í˜¸í™˜ì„± ê²€ì‚¬
        pip check || echo "âš ï¸ Some dependency conflicts detected"
        
    - name: ðŸ“ Generate update report
      run: |
        echo "ðŸ“ Generating dependency update report..."
        
        # Git diffë¡œ ë³€ê²½ì‚¬í•­ í™•ì¸
        git diff --name-only requirements/ > changed_files.txt
        
        if [ -s changed_files.txt ]; then
          echo "## ðŸ“¦ Dependency Updates" > update-report.md
          echo "" >> update-report.md
          echo "### ðŸ”„ Updated Files" >> update-report.md
          echo "" >> update-report.md
          
          while read -r file; do
            echo "- \`$file\`" >> update-report.md
          done < changed_files.txt
          
          echo "" >> update-report.md
          echo "### ðŸ“Š Detailed Changes" >> update-report.md
          echo "" >> update-report.md
          echo "\`\`\`diff" >> update-report.md
          git diff requirements/ >> update-report.md
          echo "\`\`\`" >> update-report.md
        fi
        
    - name: ðŸ“¤ Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ðŸ“¦ Update dependencies (${{ github.event.inputs.update_type || 'patch' }})
          
          - Update type: ${{ github.event.inputs.update_type || 'patch' }}
          - Security vulnerabilities: ${{ needs.security-scan.outputs.vulnerabilities-found }}
          - Updated packages: See diff for details
        title: "ðŸ“¦ Automated dependency updates (${{ github.event.inputs.update_type || 'patch' }})"
        body-path: update-report.md
        branch: feature/dependency-updates-${{ github.run_number }}
        delete-branch: true
        labels: |
          dependencies
          automated-pr
          ${{ github.event.inputs.update_type || 'patch' }}-update

  # ==============================================================================
  # 4. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
  # ==============================================================================
  test-updates:
    name: ðŸ§ª Test Dependency Updates
    runs-on: ubuntu-latest
    needs: update-dependencies
    if: needs.update-dependencies.result == 'success'
    
    strategy:
      matrix:
        service: [api, pytorch, mlflow, airflow]
        
    steps:
    - name: ðŸ“¥ Checkout updated code
      uses: actions/checkout@v4
      with:
        ref: feature/dependency-updates-${{ github.run_number }}
        
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ Install updated dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        pip install -r requirements/${{ matrix.service }}.txt
        
    - name: ðŸ§ª Run compatibility tests
      run: |
        echo "ðŸ§ª Testing ${{ matrix.service }} compatibility..."
        
        # ê¸°ë³¸ import í…ŒìŠ¤íŠ¸
        case ${{ matrix.service }} in
          "api")
            python -c "import fastapi, uvicorn, pydantic; print('âœ… FastAPI stack working')"
            ;;
          "pytorch")
            python -c "import torch, torchvision; print('âœ… PyTorch stack working')"
            ;;
          "mlflow")
            python -c "import mlflow; print('âœ… MLflow working')"
            ;;
          "airflow")
            python -c "import airflow; print('âœ… Airflow working')"
            ;;
        esac
        
    - name: ðŸ³ Test Docker build
      run: |
        echo "ðŸ³ Testing Docker build for ${{ matrix.service }}..."
        docker build -f docker/dockerfiles/Dockerfile.${{ matrix.service }} -t test-${{ matrix.service }} . || true

  # ==============================================================================
  # 5. ë³´ê³ ì„œ ìƒì„±
  # ==============================================================================
  dependency-report:
    name: ðŸ“‹ Dependency Update Report
    runs-on: ubuntu-latest
    needs: [security-scan, check-updates, update-dependencies, test-updates]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate final report
      run: |
        echo "## ðŸ“¦ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… **Security Scan**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "  - Vulnerabilities: ${{ needs.security-scan.outputs.vulnerabilities-found }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Security Scan**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.check-updates.result }}" == "success" ]; then
          echo "âœ… **Update Check**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "  - Updates Available: ${{ needs.check-updates.outputs.updates-available }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Update Check**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.update-dependencies.result }}" == "success" ]; then
          echo "âœ… **Dependencies Updated**: PR created" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-dependencies.result }}" == "skipped" ]; then
          echo "â­ï¸ **Dependencies Updated**: Skipped (no updates needed)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Dependencies Updated**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-updates.result }}" == "success" ]; then
          echo "âœ… **Update Testing**: All tests passed" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test-updates.result }}" == "skipped" ]; then
          echo "â­ï¸ **Update Testing**: Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Update Testing**: Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Review and merge the dependency update PR if created" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor for any issues after merging" >> $GITHUB_STEP_SUMMARY
        echo "- Check security reports for critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
